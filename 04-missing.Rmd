---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Missing values

```{r, include=FALSE}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path)) # set to local directory
source("srcs/helpers.R")
load(file = "data/processing/imdb_sample.RData")
load(file = "data/processing/imdb.RData")
```


## Missing value recognition

First we need to understand how the NA is encoded in the dataset. So we calculate 15 most common value among each colomns:

```{r}
imdb_sample %>%
  mutate_all(~as.character(.)) %>%
  pivot_longer(1:ncol(.)) %>%
  group_by(name, value) %>%
  summarise(nunique = n()) %>%
  group_by(name) %>%
  arrange(-nunique) %>%
  slice(1:15) %>%
  get_DT(default_show = 5)
```

- Apparently, `\N`, for example, is likely to be a tag for missing value.

```r
SIGN_of_MISSING <- c('\\N', "", "[]", "	#N/A", "#N/A")
```

```{r}
SIGN_of_MISSING <- c('\\N', "", "[]", "	#N/A", "#N/A")
imdb %>%
  mutate_all( ~ifelse(. %in% SIGN_of_MISSING, NA, .) ) %>%
  mutate_at("isAdult", ~ifelse(. %in% c('0', '1'), ., NA) ) -> imdb
```



## Missing by columns and rows

We first take a glance of the missingness.

- By colomns: 

```{r}
colSums(is.na(imdb)) %>%
  sort(decreasing = TRUE)
```

  - 7 colomns are complete.
  - `endYear` and `runtimeMinutes` seem to be a severely missing columns.

- By rows: we pick the 50 most popularly voted pieces of work, and check their missingness:

```{r}
imdb %>% 
  mutate(startYear = as.numeric(startYear)) %>%
  arrange(-startYear) %>%
  group_by(primaryTitle) %>%
  slice(1) %>% ungroup %>%
  arrange(-numVotes) %>%
  slice(1:50) %>%
  column_to_rownames("primaryTitle") -> imdb_mostvotes
```

```{r}
rowSums(is.na(imdb_mostvotes)) %>%
  sort(decreasing = TRUE) 
```

  - Only 1 and 0 colomn is missing in these rows. To double check that:

- By rows & colomns: 

```{r,fig.width=7,fig.height=9}
tidyimdb <- imdb_mostvotes %>% 
    rownames_to_column("id") %>% 
    gather(key, value, -id) %>% 
    mutate(missing = ifelse(is.na(value), "yes", "no"))

ggplot(tidyimdb, aes(x = key, y = fct_rev(id), fill = missing)) +
  geom_tile(color = "white") + 
  scale_fill_viridis_d() + 
  theme_bw() +
  labs(y = "Movie",
       x = "Variable",
       title = "Missing values by rows & columns") +
  theme_jace
```

  - **Observations:** Nothing but endYear is missing frequently. We can infer that:
  
    1. The most popular works have relatively complete information available to public
    
    2. Movies are being voted much more than TV series, since only TV series has `endYear` as an attribute. 


## Missing plot

### Heatmap

Then we chan the missing value plot we coded from the PSet 4.

```{r,fig.width=11,fig.height=8}
imdb %>%
  plot_missing(percent = T, long_axis = T)
```

The most prevalent missing pattern is indeed the missing endYear, accounting for about 70% of the cases, which is driven by the fact that the `endYear` variable is missing in nearly all of the samples. In addition, `runtimeMinutes` and `endYear` are frequently absent simultaneously, whereas `genres` and `startYear` are missing in minor amounts.


### Heatmap

```{r}
x <- missing_data.frame(imdb_mostvotes)
image(x)
```

```{r,fig.width=11,fig.height=8}
tidyimdb2 <- tidyimdb %>% mutate(value2 = as.numeric(value))
ggplot(tidyimdb2, aes(x = key, y = fct_rev(id), fill = value2)) +
  geom_tile(color = "white") + 
  scale_fill_gradient(low = "grey80", high = "red", na.value = "black") + theme_bw()
```

  - **Observations:** ggtile() may not work very well this time because most of the values in our dataset are discrete and non-numeric.

```{r,fig.width=11,fig.height=8}
tidyimdb2 %>%
  mutate(missing2 = ifelse(missing == "yes", 1, 0)) %>%

ggplot(aes(x = fct_reorder(key, -missing2, sum), y = fct_reorder(id, -missing2, sum), fill = value2)) +
  geom_tile(color = "white") + 
  scale_fill_gradient2(low = "blue", mid = "white", high ="yellow", na.value = "black") + theme_bw()
```

## Inight about why NA happens

We have already seen from *missing by column* that only four of the attributes have missing values. Therefore, it may not be meaningful to compare the missing values by year, rating, or votes, etc.